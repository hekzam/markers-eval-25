# Hekzam Markers - Optimisation des marqueurs pour la correction d'examens

## Description du projet

Hekzam est un ensemble de logiciels con√ßu pour permettre la cr√©ation et la correction automatis√©e ou semi-automatis√©e des examens papier.  
Actuellement, Hekzam utilise des **QR codes** comme marqueurs de bord pour la calibration et l'identification des pages des copies d'examen. Cependant, ces marqueurs pr√©sentent plusieurs inconv√©nients :

- **Co√ªt √©lev√© en encre** : les QR codes sont denses et n√©cessitent une quantit√© importante d'encre.
- **Espace occup√© important** : ils r√©duisent la place disponible pour le contenu p√©dagogique.
- **Consommation de ressources computationnelles** : leur g√©n√©ration et leur reconnaissance demandent un traitement relativement lourd.

### Objectif du projet

L'objectif de ce projet est de **d√©velopper et √©valuer des alternatives aux QR codes** utilis√©es actuellement dans Hekzam.  
Les nouvelles solutions devront √™tre plus sobres en encre et en espace tout en maintenant une **grande robustesse** dans leur d√©tection.

## D√©pendances n√©cessaires

Avant de compiler et d'ex√©cuter le projet, installez les d√©pendances suivantes :

```sh
sudo apt-get install cmake ninja-build libopencv-dev nlohmann-json3-dev snapd
sudo snap install typst
```

- `cmake` : Outil de g√©n√©ration de build.
- `ninja-build` : Syst√®me de compilation rapide.
- `libopencv-dev` : Biblioth√®que de traitement d‚Äôimage pour l‚Äôalignement et la reconnaissance des marqueurs.
- `nlohmann-json3-dev` : Gestion du format JSON pour la structuration des donn√©es.
- `snapd` & `typst` : G√©n√©ration des formulaires d'examen via Typst.
- `libzbar-dev` & `libzbar0` : si vous souhaitez utiliser zbar pour la d√©tection des QR codes au lieu de ZXing.

## Compilation du projet

Une fois les d√©pendances install√©es, compilez le projet avec :

```sh
cmake -H. -Bbuild-cmake -GNinja -DCMAKE_BUILD_TYPE=Release
cmake --build build-cmake -j
```

- `-H.` : Sp√©cifie le r√©pertoire source.
- `-Bbuild-cmake` : D√©finit le r√©pertoire de build.
- `-GNinja` : Utilisation de Ninja comme g√©n√©rateur de build.
- `-DCMAKE_BUILD_TYPE=Release` : Compilation optimis√©e.
- `-DENABLE_ZBAR=ON` : si vous souhaitez utiliser zbar pour la d√©tection des QR codes au lieu de ZXing.

## üìÑ G√©n√©ration de copie

Une fois la compilation termin√©e, utilisez la commande suivante pour g√©n√©rer les copies :

```sh
./create-copie.sh [options]
```

Ce script permet de produire une copie vers le dossier de sortie **copies/**.

### Options disponibles

```
  --encoded-size N      : Taille des marqueurs encod√©s (par d√©faut: 15)
  --unencoded-size N     : Taille des marqueurs non encod√©s (par d√©faut: 3)
  --header-size N       : Taille du marqueur d'ent√™te (par d√©faut: 7)
  --stroke-width N      : Largeur du trait des marqueurs (par d√©faut: 2)
  --margin N            : Marge autour des marqueurs (par d√©faut: 3)
  --grey-level N        : Niveau de gris (0: noir, 255: blanc) (par d√©faut: 0)
  --dpi N               : R√©solution en points par pouce (par d√©faut: 300)
  --generating-content BOOL : G√©n√©rer le contenu dans le document (1/true ou 0/false) (par d√©faut: 1)
  --filename NAME       : Nom du fichier de sortie (par d√©faut: copy)
  
  Options de configuration personnalis√©e des marqueurs:
  --tl TYPE             : Type de marqueur pour le coin sup√©rieur gauche
  --tr TYPE             : Type de marqueur pour le coin sup√©rieur droit
  --bl TYPE             : Type de marqueur pour le coin inf√©rieur gauche
  --br TYPE             : Type de marqueur pour le coin inf√©rieur droit
  --header TYPE         : Type de marqueur pour l'en-t√™te

  Format des types de marqueurs: type[:encoded][:outlined]
  - type:outlined     : Marqueur non rempli (Ne fonctionne que pour les formes g√©om√©triques simples)
  - type:encoded      : Marqueur avec donn√©es encod√©es
  - type:unencoded    : Marqueur sans donn√©es encod√©es
```

Exemple avec une configuration compl√®te personnalis√©e:
```sh
./create-copie.sh --tl circle:outlined --tr circle:outlined --bl none --br qrcode:encoded --header qrcode:encoded --encoded-size 20 --unencoded-size 12 --grey-level 80 --header-size 18 --dpi 600 --filename exam_high_res
```

### Marqueurs disponibles

| Encodable       | Non encodable     | Rectangulaire    |
|-----------------|-------------------|------------------|
| qrcode          | circle            | pdf417           |
| micro-qr        | square            | rmqr             |
| datamatrix      | triangle          | code128          |
| aztec           | cross             |                  |
| pdf417          | aruco             |                  |
| rmqr            | qr-eye            |                  |
| code128         | custom            |                  |

## üìä Ex√©cution du benchmark

Vous pouvez ex√©cuter l'outil de benchmark pour √©valuer les performances des diff√©rentes configurations de marqueurs :

```sh
./run_benchmark.sh [options]
```

### Benchmarks disponibles

Le syst√®me propose plusieurs types de benchmarks, s√©lectionnables avec l'option `--benchmark` :

- `parsing-time` : √âvalue les performances d'analyse et de d√©tection des marqueurs
- `generation-time` : √âvalue les performances de g√©n√©ration des copies (par d√©faut)
- `ink-estimation` : Estime la consommation d'encre pour diff√©rentes configurations de marqueurs

### Options en ligne de commande

Vous pouvez passer les param√®tres directement en ligne de commande :

```sh
./run_benchmark.sh --benchmark ink-estimation --input-dir=./copies --dpi=600
```

Options communes :
- `--benchmark=<type>` : Type de benchmark √† ex√©cuter (parsing-time, generation-time, ink-estimation)
- `--output-dir=<path>` : R√©pertoire de sortie pour les r√©sultats
- `--input-dir=<path>` : R√©pertoire contenant les images d'entr√©e
- `--encoded-marker_size=<N>` : Taille des marqueurs encod√©s en mm
- `--unencoded-marker_size=<N>` : Taille des marqueurs non encod√©s en mm
- `--header-marker_size=<N>` : Taille du marqueur d'en-t√™te en mm
- `--grey-level=<0-255>` : Niveau de gris pour les marqueurs
- `--dpi=<N>` : R√©solution en points par pouce

Options sp√©cifiques pour les benchmarks de performance :
- `--nb-copies=<N>` : Nombre de copies √† g√©n√©rer pour le test
- `--warmup-iterations=<N>` : Nombre d'it√©rations d'√©chauffement avant la mesure
- `--atomic-boxes-file=<path>` : Fichier JSON contenant les d√©finitions des zones

### R√©sultats des benchmarks

#### Benchmark de temps de traitement

Le benchmark `parsing-time` produit des r√©sultats sur le temps de traitement et le taux de succ√®s de la d√©tection des marqueurs. Il g√©n√®re les fichiers suivants dans le r√©pertoire de sortie :
- **Images calibr√©es** : Versions redress√©es des copies avec les zones d√©tect√©es
- **CSV de r√©sultats** : Fichier `benchmark_results.csv` avec les temps d'ex√©cution et taux de succ√®s
- **Images de d√©bogage** (mode DEBUG uniquement) : Visualisation du processus de d√©tection

#### Benchmark d'estimation d'encre

Le benchmark `ink-estimation` analyse la consommation d'encre et affiche :
- Dimensions de l'image et r√©solution
- Surface totale couverte en cm¬≤
- Couverture d'encre moyenne en pourcentage
- Volume d'encre estim√© en millilitres
- Facteur de calibration utilis√©

#### Benchmark de temps de g√©n√©ration de copies
Le benchmark `generation-time` √©value le temps de g√©n√©ration des copies. Il g√©n√®re un fichier CSV avec les r√©sultats de chaque it√©ration.

L'option `--warmup-iterations` est particuli√®rement utile pour obtenir des mesures plus pr√©cises. Les it√©rations d'√©chauffement ex√©cutent le m√™me code que les it√©rations de mesure, mais leurs r√©sultats ne sont pas comptabilis√©s dans les statistiques finales. Cela permet d'√©viter que les co√ªts de d√©marrage (chargement initial des biblioth√®ques, initialisation des caches, etc.) n'affectent les mesures de performance.

### R√©sultats du benchmark

Apr√®s l'ex√©cution, le benchmark produit plusieurs types de sorties :

- **Images calibr√©es** : Versions redress√©es des copies scann√©es avec les zones d√©tect√©es surlign√©es
- **CSV de r√©sultats** : Fichier `benchmark_results.csv` contenant les temps d'ex√©cution et taux de succ√®s pour chaque image
- **Images de d√©bogage** (si compil√© en mode DEBUG) : Visualisation du processus de d√©tection des marqueurs

Le fichier CSV contient trois colonnes:
- **File**: Nom du fichier trait√©
- **Time(ms)**: Temps d'ex√©cution en millisecondes
- **Success**: Indique si la d√©tection des marqueurs a r√©ussi (1) ou √©chou√© (0)

Ces donn√©es vous permettent d'analyser:
- Le taux de succ√®s global de la d√©tection pour chaque configuration de marqueurs
- Le temps moyen de traitement
- L'impact des diff√©rents param√®tres (taille, niveau de gris, etc.) sur les performances

Les images calibr√©es montrent les zones d√©tect√©es avec les codes couleur suivants:
- **Rose**: Zones utilisateur (zones de r√©ponse)
- **Bleu**: Marqueurs de coin
- **Vert**: Centre des marqueurs de coin

## üìÇ Structure du projet

```
.
‚îú‚îÄ‚îÄ include/            # Fichiers d'en-t√™te (*.h, *.hpp)
‚îÇ   ‚îú‚îÄ‚îÄ benchmark.hpp   # En-t√™tes pour le benchmarking
‚îÇ   ‚îî‚îÄ‚îÄ common.h        # D√©finitions de structures communes
‚îú‚îÄ‚îÄ src/                # Code source C++ principal
‚îÇ   ‚îú‚îÄ‚îÄ bench/          # Code source des benchmarks
‚îÇ   ‚îú‚îÄ‚îÄ benchmark.cpp   # Outil de benchmarking
‚îÇ   ‚îú‚îÄ‚îÄ expl_pars.cpp   # Parseur principal
‚îÇ   ‚îú‚îÄ‚îÄ typst_interface.cpp # Interface avec Typst
‚îÇ   ‚îú‚îÄ‚îÄ utils/          # Utilitaires partag√©s
‚îÇ   ‚îú‚îÄ‚îÄ parser/         # Impl√©mentation des parseurs de marqueurs
‚îÇ   ‚îî‚îÄ‚îÄ external-tools/ # Outils externes (cr√©ation de copies)
‚îú‚îÄ‚îÄ typst/              # Sources de templates Typst
‚îÇ   ‚îú‚îÄ‚îÄ components/     # Composants r√©utilisables (marqueurs, conteneurs)
‚îÇ   ‚îú‚îÄ‚îÄ common/         # Variables et utilitaires communs
‚îÇ   ‚îú‚îÄ‚îÄ content/        # Contenu des formulaires
‚îÇ   ‚îú‚îÄ‚îÄ src/            # Scripts de g√©n√©ration
‚îÇ   ‚îú‚îÄ‚îÄ style/          # Configuration de style
‚îÇ   ‚îî‚îÄ‚îÄ template.typ    # Template principal
‚îú‚îÄ‚îÄ stats-analysis/     # Scripts et outils d'analyse statistique
‚îú‚îÄ‚îÄ copies/             # Dossier de sortie pour les copies g√©n√©r√©es
‚îú‚îÄ‚îÄ output/             # Dossier de sortie pour les r√©sultats d'analyse
‚îú‚îÄ‚îÄ build-cmake/        # R√©pertoire de build (g√©n√©r√©)
‚îú‚îÄ‚îÄ CMakeLists.txt      # Configuration du projet CMake
‚îú‚îÄ‚îÄ create-copie.sh     # Script de g√©n√©ration de copies
‚îú‚îÄ‚îÄ run_benchmark.sh    # Script d'ex√©cution du benchmark
‚îú‚îÄ‚îÄ README.md           # Ce fichier
‚îî‚îÄ‚îÄ LICENSE             # Fichier de licence
```

## üìñ R√©f√©rences techniques

- **OpenCV** : [https://opencv.org/](https://opencv.org/)
- **Typst** : [https://typst.app/](https://typst.app/)
- **ZXing** : [https://github.com/zxing/zxing](https://github.com/zxing/zxing)

## ‚öñÔ∏è License

- Code: Apache-2.0
- Everything else, in particular documentation and measurements: CC-BY-SA-4.0
