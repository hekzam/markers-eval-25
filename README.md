# Hekzam Markers - Optimisation des marqueurs pour la correction d'examens

## Description du projet

Hekzam est un ensemble de logiciels con√ßu pour permettre la cr√©ation et la correction automatis√©e ou semi-automatis√©e des examens papier.  
Actuellement, Hekzam utilise des **QR codes** comme marqueurs de bord pour la calibration et l'identification des pages des copies d'examen. Cependant, ces marqueurs pr√©sentent plusieurs inconv√©nients :

- **Co√ªt √©lev√© en encre** : les QR codes sont denses et n√©cessitent une quantit√© importante d'encre.
- **Espace occup√© important** : ils r√©duisent la place disponible pour le contenu p√©dagogique.
- **Consommation de ressources computationnelles** : leur g√©n√©ration et leur reconnaissance demandent un traitement relativement lourd.

### Objectif du projet

L'objectif de ce projet est de **d√©velopper et √©valuer des alternatives aux QR codes** utilis√©es actuellement dans Hekzam.  
Les nouvelles solutions devront √™tre plus sobres en encre et en espace tout en maintenant une **grande robustesse** dans leur d√©tection.

## D√©pendances n√©cessaires

Avant de compiler et d'ex√©cuter le projet, installez les d√©pendances suivantes :

```sh
sudo apt-get install cmake ninja-build libopencv-dev nlohmann-json3-dev snapd
sudo snap install typst
```

- `cmake` : Outil de g√©n√©ration de build.
- `ninja-build` : Syst√®me de compilation rapide.
- `libopencv-dev` : Biblioth√®que de traitement d‚Äôimage pour l‚Äôalignement et la reconnaissance des marqueurs.
- `nlohmann-json3-dev` : Gestion du format JSON pour la structuration des donn√©es.
- `snapd` & `typst` : G√©n√©ration des formulaires d'examen via Typst.
- `libzbar-dev` & `libzbar0` : si vous souhaitez utiliser zbar pour la d√©tection des QR codes au lieu de ZXing.

## Compilation du projet

Une fois les d√©pendances install√©es, compilez le projet avec :

```sh
cmake -H. -Bbuild-cmake -GNinja -DCMAKE_BUILD_TYPE=Release
cmake --build build-cmake -j
```

- `-H.` : Sp√©cifie le r√©pertoire source.
- `-Bbuild-cmake` : D√©finit le r√©pertoire de build.
- `-GNinja` : Utilisation de Ninja comme g√©n√©rateur de build.
- `-DCMAKE_BUILD_TYPE=Release` : Compilation optimis√©e.
- `-DENABLE_ZBAR=ON` : si vous souhaitez utiliser zbar pour la d√©tection des QR codes au lieu de ZXing.

## üìÑ G√©n√©ration de copie

Une fois la compilation termin√©e, vous pouvez g√©n√©rer des copies d'examen avec diff√©rents types de marqueurs.

Utilisez la commande suivante pour g√©n√©rer des copies avec des options personnalis√©es :

```sh
./create-copie.sh [options]
```

Les copies g√©n√©r√©es sont sauvegard√©es dans le dossier **copies/**.

### Types de marqueurs disponibles

| Encodable       | Non encodable     | Rectangulaire    |
|-----------------|-------------------|------------------|
| qrcode          | circle            | pdf417           |
| microqr         | square            | rmqr             |
| datamatrix      | cross             | code128          |
| aztec           | aruco             |                  |
| pdf417          | qreye             |                  |
| rmqr            | custom            |                  |
| code128         |                   |                  |

### Options de configuration

- `--encoded-size <N>`          : Taille des marqueurs encod√©s (par d√©faut: 15)
- `--unencoded-size <N>`        : Taille des marqueurs non encod√©s (par d√©faut: 3)
- `--header-size <N>`           : Taille du marqueur d'ent√™te (par d√©faut: 7)
- `--stroke-width <N>`          : Largeur du trait des marqueurs (par d√©faut: 2)
- `--margin <N>`                : Marge autour des marqueurs (par d√©faut: 3)
- `--grey-level <N>`            : Niveau de gris (0: noir, 255: blanc) (par d√©faut: 0)
- `--dpi <N>`                   : R√©solution en points par pouce (par d√©faut: 300)
- `--generating-content <BOOL>` : G√©n√©rer le contenu dans le document (1/true ou 0/false) (par d√©faut: 1)
- `--filename <name>`           : Nom du fichier de sortie (par d√©faut: copy)
- `--tl <type>`                 : Type de marqueur pour le coin sup√©rieur gauche (par d√©faut: qrcode:encoded)
- `--tr <type>`                 : Type de marqueur pour le coin sup√©rieur droit (par d√©faut: qrcode:encoded)
- `--bl <type>`                 : Type de marqueur pour le coin inf√©rieur gauche (par d√©faut: qrcode:encoded)
- `--br <type>`                 : Type de marqueur pour le coin inf√©rieur droit (par d√©faut: qrcode:encoded)
- `--header <type>`             : Type de marqueur pour l'en-t√™te (par d√©faut: none)
- `--verbose`                   : Affiche tous les messages de sortie des commandes de typst (par d√©faut: non affich√©)

#### Format des types de marqueurs

```
  Format: type[:encoded][:outlined]
  - type:outlined     : Marqueur non rempli (uniquement pour formes g√©om√©triques simples)
  - type:encoded      : Marqueur avec donn√©es encod√©es
  - none              : Aucun marqueur √† cette position
```

> **Note sur l'encodage :** Par d√©faut, les marqueurs encodables contiennent uniquement l'information de leur position (coin sup√©rieur gauche, sup√©rieur droit, etc.). Avec l'option `:encoded`, le marqueur encodera √©galement le num√©ro de la page, de la copie ainsi que le nom de l'examen.

### Exemples

#### Exemple simple avec des QR codes
```sh
./create-copie.sh --tl qrcode --tr qrcode --bl qrcode --br qrcode --header qrcode
```

#### Configuration avanc√©e avec diff√©rents marqueurs
```sh
./create-copie.sh --tl circle:outlined --tr circle:outlined --bl none --br qrcode:encoded --header qrcode:encoded --encoded-size 20 --unencoded-size 12 --grey-level 80 --header-size 18 --dpi 600 --filename exam_high_res
```

## üìä Ex√©cution du benchmark

Le projet inclut plusieurs outils de benchmark pour √©valuer diff√©rents aspects des marqueurs, comme leur consommation d'encre, leur facilit√© de d√©tection, et leurs performances globales.

### Ex√©cution des benchmarks

Vous disposez de deux m√©thodes pour ex√©cuter les benchmarks :

#### 1. Mode ligne de commande (recommand√©)

Sp√©cifiez directement tous les param√®tres dans votre commande :

```sh
./run_benchmark.sh --benchmark [nom-du-benchmark] [autres-options]
```

Exemple :
```sh
./run_benchmark.sh --benchmark gen-parse --nb-copies 5 --marker-config "(qrcode:encoded,qrcode:encoded,qrcode:encoded,qrcode:encoded,none)" --parser-type QRCODE
```

#### 2. Mode interactif

Ex√©cutez simplement la commande en sp√©cifiant au minimum le type de benchmark :

```sh
./run_benchmark.sh --benchmark [nom-du-benchmark]
```

Le script vous guidera ensuite pour saisir les autres param√®tres via une interface interactive dans le terminal.

> **Note** : Si vous ne sp√©cifiez pas de type avec l'option `--benchmark`, le benchmark par d√©faut sera `config-analysis`.

#### 3. Mode batch

Vous pouvez √©galement ex√©cuter une s√©rie de benchmarks depuis un fichier texte contenant les commandes :

```sh
./run_benchmark.sh --batch-file [chemin-vers-fichier]
```

Chaque ligne du fichier doit contenir un type de benchmark et ses options. Les lignes vides ou commen√ßant par `#` sont ignor√©es.

Exemple de fichier batch.txt :
```
gen-parse --nb-copies 3 --marker-config "(qrcode:encoded,qrcode:encoded,qrcode:encoded,qrcode:encoded,none)"
config-analysis --marker-config "(datamatrix:encoded,datamatrix:encoded,datamatrix:encoded,datamatrix:encoded,none)"
# Cette ligne est un commentaire
gen-parse --nb-copies 2 --marker-config "(circle:outlined,circle:outlined,circle:outlined,circle:outlined,none)"
```

#### Types de benchmark disponibles

Voici les diff√©rents types de benchmarks que vous pouvez ex√©cuter :

1. **gen-parse** : √âvalue le temps de g√©n√©ration des copies, le temps de traitement et le taux de succ√®s de la d√©tection des marqueurs. Il mesure √©galement la pr√©cision de la rectification des copies apr√®s d√©tection.
   ```sh
   ./run_benchmark.sh --benchmark gen-parse
   ```

   **Options sp√©cifiques** :
   - `--parser-type <type>` : Type de parseur √† utiliser (QRCODE, ARUCO, CIRCLE, etc.)
   - `--nb-copies <N>` : Nombre de copies √† g√©n√©rer et analyser
   - `--seed <N>` : Graine pour la g√©n√©ration al√©atoire (0 pour une graine bas√©e sur le temps)
   - `--warmup-iterations <N>` : Nombre d'it√©rations d'√©chauffement avant les mesures

2. **config-analysis** : Analyse la consommation d'encre et la surface occup√©e par les marqueurs.
   ```sh
   ./run_benchmark.sh --benchmark config-analysis
   ```

   **Options sp√©cifiques** :
   - `--calibration-factor <N>` : Facteur de calibration pour le calcul de consommation d'encre (ml/cm¬≤)

### Types de parseurs disponibles

Le syst√®me prend en charge plusieurs types de parseurs pour la d√©tection et le traitement des marqueurs. Lors de l'utilisation de l'option `--parser-type` dans les benchmarks, vous pouvez sp√©cifier l'un des parseurs suivants :

1. **QRCODE** (par d√©faut) : Parseur standard pour les codes QR. D√©tecte les marqueurs QR code encod√©s avec l'identifiant de position (tl, tr, bl, br) et extrait les m√©tadonn√©es.

2. **EMPTY** : Parseur pour les codes QR sans identification de position. Utilise la disposition pour d√©terminer quelle position est occup√©e par quel marqueur.

3. **CIRCLE** : D√©tecte les marqueurs circulaires et les utilise avec un QR code d'identification pour d√©terminer l'orientation.

4. **ARUCO** : D√©tecte les marqueurs ArUco (codes carr√©s sp√©cifiques pour la r√©alit√© augment√©e) et les utilise pour l'alignement. N√©cessite un QR code pour les m√©tadonn√©es.

5. **CENTER_MARKER_PARSER** : D√©tecte les marqueurs √† partir du centre de la page, utile lorsque les marqueurs ne sont pas positionn√©s dans les coins.

6. **CUSTOM_MARKER** : D√©tecte des formes personnalis√©es d√©finies comme marqueurs. Exp√©rimental.

7. **SHAPE** : D√©tecte les marqueurs bas√©s sur des formes g√©om√©triques simples. Utilise un processus de d√©tection des contours.

8. **DEFAULT_PARSER** : Impl√©mentation par d√©faut (ne fait rien). Utile principalement √† des fins de test ou comme point de d√©part pour de nouveaux parseurs.

Exemple d'utilisation avec un parseur sp√©cifique :
```sh
./run_benchmark.sh --benchmark gen-parse --parser-type CIRCLE --marker-config "(circle:outlined,circle:outlined,circle:outlined,circle:outlined,none)"
```

> **Note** : Tous les parseurs ne sont pas compatibles avec tous les types de marqueurs. Par exemple, le parseur CIRCLE ne fonctionnera correctement qu'avec des marqueurs de type cercle, et le parseur ARUCO avec des marqueurs ArUco.

### Options communes √† tous les benchmarks

- `--marker-config <config>` : Configuration des marqueurs (par d√©faut: `(qrcode:encoded,qrcode:encoded,qrcode:encoded,qrcode:encoded,none)`)
  > Format: (tl,tr,bl,br,header) o√π tl=top-left, tr=top-right, bl=bottom-left, br=bottom-right, header=en-t√™te.
  > Utilisez "none" pour les positions qui ne sont pas occup√©es par des marqueurs.
- `--encoded-marker-size <N>` : Taille des marqueurs encod√©s en mm (par d√©faut: 13)
- `--unencoded-marker-size <N>` : Taille des marqueurs non encod√©s en mm (par d√©faut: 10)
- `--header-marker-size <N>` : Taille du marqueur d'en-t√™te en mm (par d√©faut: 7)
- `--grey-level <0-255>` : Niveau de gris pour les marqueurs (par d√©faut: 0)
- `--dpi <N>` : R√©solution en points par pouce (par d√©faut: 300)
- `--csv-mode <mode>` : Mode de gestion des fichiers CSV existants :
  - `overwrite` : Supprime les fichiers CSV existants et cr√©e un nouveau fichier (par d√©faut)
  - `append` : Conserve le fichier CSV existant et ajoute les nouveaux r√©sultats √† la fin
- `--csv-filename <nom>` : Nom du fichier CSV pour les r√©sultats (par d√©faut: "benchmark_results.csv")

### Format des fichiers de r√©sultats

Les r√©sultats des benchmarks sont sauvegard√©s dans le dossier `output/csv/` au format CSV. Les fichiers incluent :

- Pour **gen-parse** : Noms des fichiers, temps de g√©n√©ration, temps de parsing, succ√®s du parsing, type de parseur, configuration des marqueurs, erreurs de pr√©cision, etc.
- Pour **config-analysis** : Configuration des marqueurs, estimation de consommation d'encre, zone totale occup√©e par les marqueurs, etc.

### Exemples d'utilisation

#### Exemple 1 : Benchmark simple avec le parseur QR code
```sh
./run_benchmark.sh --benchmark gen-parse --nb-copies 3 --parser-type QRCODE
```

#### Exemple 2 : Analyse de consommation d'encre pour un marqueur sp√©cifique
```sh
./run_benchmark.sh --benchmark config-analysis --marker-config "(circle:outlined,circle:outlined,circle:outlined,circle:outlined,none)" --grey-level 50
```

#### Exemple 3 : Benchmark complet avec options avanc√©es
```sh
./run_benchmark.sh --benchmark gen-parse --nb-copies 10 --parser-type QRCODE --marker-config "(qrcode:encoded,qrcode:encoded,qrcode:encoded,qrcode:encoded,qrcode:encoded)" --encoded-marker-size 15 --warmup-iterations 2 --seed 42
```

## üñ®Ô∏è Simulateur de scan et d'impression

Le projet inclut un simulateur Python qui permet d'appliquer diverses transformations aux documents g√©n√©r√©s, simulant ainsi des d√©fauts d'impression et de num√©risation pour des tests de robustesse.

### Ex√©cution du simulateur

Pour ex√©cuter le simulateur sur une image originale, utilisez la commande suivante :

```sh
python tools/pdf_noiser/printer_emulator.py [options]
```

Par d√©faut, le script appliquera des transformations al√©atoires √† l'image originale situ√©e dans `copies/original.png` et g√©n√©rera 10 copies avec des d√©fauts diff√©rents dans le dossier `tools/pdf_noiser/noisy_copies/`.

### Transformations disponibles

Le simulateur peut appliquer les transformations suivantes pour imiter les d√©fauts d'impression et de num√©risation :

- **Rotation** (`-r`, `--rotation`) : Applique une rotation √† l'image (en degr√©s, ¬±3¬∞ max par d√©faut)
- **Translation** (`-t`, `--translation`) : D√©place l'image (d√©placement X,Y, ¬±25px max par d√©faut)
- **Contraste** (`-c`, `--contrast`) : Modifie le contraste (0-100%, plage effective 0.8-1.2)
- **Luminosit√©** (`-b`, `--brightness`) : Ajuste la luminosit√© (0-100%, plage effective 0.8-1.2)
- **Bruit gaussien** (`-g`, `--gaussian`) : Ajoute du bruit gaussien (0-100%, intensit√© 4-6 max)
- **Bruit sel et poivre** (`-s`, `--salt_pepper`) : Ajoute des pixels noirs et blancs al√©atoires (0-100%, 6% max)
- **Taches al√©atoires** (`-p`, `--spot`) : Ajoute des taches noires (0-100%, 2-5 taches par d√©faut)
- **Nombre de copies** (`-n`, `--nb_copy`) : Nombre de copies √† g√©n√©rer (10 par d√©faut)

### Exemples d'utilisation

#### G√©n√©rer 5 copies avec des d√©fauts al√©atoires
```sh
python tools/pdf_noiser/printer_emulator.py --nb_copy 5
```

#### G√©n√©rer une copie avec une rotation sp√©cifique
```sh
python tools/pdf_noiser/printer_emulator.py --rotation 2 --nb_copy 1
```

#### Combiner plusieurs transformations
```sh
python tools/pdf_noiser/printer_emulator.py --rotation 1.5 --contrast 75 --brightness 60 --gaussian 30 --nb_copy 3
```

## üìÇ Structure du projet

```
.
‚îú‚îÄ‚îÄ include/                   # Fichiers d'en-t√™te (*.h, *.hpp)
‚îÇ   ‚îú‚îÄ‚îÄ benchmark.hpp          # En-t√™tes pour le benchmarking
‚îÇ   ‚îî‚îÄ‚îÄ common.h               # D√©finitions de structures communes
‚îú‚îÄ‚îÄ src/                       # Code source C++ principal
‚îÇ   ‚îú‚îÄ‚îÄ bench/                 # Code source des benchmarks
‚îÇ   ‚îú‚îÄ‚îÄ benchmark.cpp          # Outil de benchmarking
‚îÇ   ‚îú‚îÄ‚îÄ expl_pars.cpp          # Parseur principal
‚îÇ   ‚îú‚îÄ‚îÄ typst_interface.cpp    # Interface avec Typst
‚îÇ   ‚îú‚îÄ‚îÄ utils/                 # Utilitaires partag√©s
‚îÇ   ‚îú‚îÄ‚îÄ parser/                # Impl√©mentation des parseurs de marqueurs
‚îÇ   ‚îî‚îÄ‚îÄ external-tools/        # Outils externes (cr√©ation de copies)
‚îú‚îÄ‚îÄ tools/                     # Scripts et utilitaires
‚îÇ   ‚îú‚îÄ‚îÄ format.py              # Formatter de code (clang-format)
‚îÇ   ‚îî‚îÄ‚îÄ pdf_noiser/            # Outils de simulation de d√©fauts
‚îÇ       ‚îî‚îÄ‚îÄ printer_emulator.py # Simulateur de d√©fauts d'impression/scan
‚îú‚îÄ‚îÄ typst/                     # Sources de templates Typst
‚îÇ   ‚îú‚îÄ‚îÄ components/            # Composants r√©utilisables (marqueurs, conteneurs)
‚îÇ   ‚îú‚îÄ‚îÄ common/                # Variables et utilitaires communs
‚îÇ   ‚îú‚îÄ‚îÄ content/               # Contenu des formulaires
‚îÇ   ‚îú‚îÄ‚îÄ src/                   # Scripts de g√©n√©ration
‚îÇ   ‚îú‚îÄ‚îÄ style/                 # Configuration de style
‚îÇ   ‚îî‚îÄ‚îÄ template.typ           # Template principal
‚îú‚îÄ‚îÄ stats-analysis/            # Scripts et outils d'analyse statistique
‚îú‚îÄ‚îÄ copies/                    # Dossier de sortie pour les copies g√©n√©r√©es
‚îú‚îÄ‚îÄ output/                    # Dossier de sortie pour les r√©sultats d'analyse
‚îú‚îÄ‚îÄ build-cmake/               # R√©pertoire de build (g√©n√©r√©)
‚îú‚îÄ‚îÄ CMakeLists.txt             # Configuration du projet CMake
‚îú‚îÄ‚îÄ create-copie.sh            # Script de g√©n√©ration de copies
‚îú‚îÄ‚îÄ run_benchmark.sh           # Script d'ex√©cution du benchmark
‚îú‚îÄ‚îÄ README.md                  # Ce fichier
‚îî‚îÄ‚îÄ LICENSE                    # Fichier de licence
```

## üìñ R√©f√©rences techniques

- **OpenCV** : [https://opencv.org/](https://opencv.org/)
- **Typst** : [https://typst.app/](https://typst.app/)
- **ZXing** : [https://github.com/zxing/zxing](https://github.com/zxing/zxing)

## ‚öñÔ∏è License

- Code: Apache-2.0
- Everything else, in particular documentation and measurements: CC-BY-SA-4.0